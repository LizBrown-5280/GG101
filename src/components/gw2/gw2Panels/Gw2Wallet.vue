<template>
  <div id="wallet">
    <div v-if="permissionsRestricted" class="permissionsRestricted">
      Permissions were not granted to access your Wallet with the key provided.
      <br />
      To see more, use a Permissions Key that includes access to your Wallet.
    </div>

    <div class="gems">
      <button>Gems used in Black Lions Trading Post (1)</button>
      <div class="row">
        <Gw2Card v-if="gems[0]?.id" :currency="gems[0]" />

        <div class="amount">
          {{ gems[0]?.amount }} <img :src="gems[0]?.icon" :title="gems[0]?.name" />
        </div>
      
        <div class="name">{{ gems[0]?.name }}s</div>
      </div>
    </div>

    <div class="currencies">
      <button>Currencies used in the game ({{ currencyCount}}{{ currencies.length }}):</button>
      <div class="row" v-for="currency in currenciesByOrder" :key="currency.id">
        <Gw2Card :currency="currency" />

        <div class="amount">
          <div v-if="currency.id !== 1" class="amount">
            {{ currency.amount }} <img :src="currency.icon" :title="currency.name" />
          </div>
          <div v-else class="amount">
            {{ currency.coins.goldCoins }}<img :src="currency.coins.goldIcon" title="Gold">
            {{ currency.coins.silverCoins }}<img :src="currency.coins.silverIcon"  title="Silver">
            {{ currency.coins.copperCoins }}<img :src="currency.coins.copperIcon"  title="Copper">
          </div>
        </div>
  
        <div class="name">{{ currency.name }}</div>
      </div>
    </div>
  </div>
</template>

<script setup>
  import { ref, reactive, onMounted, watch } from 'vue'
  import { storeToRefs } from 'pinia'
  import { useGW2Store } from '@/stores/GW2'
  import { useGw2WalletDemoData} from '@/stores/GW2WalletDemoData'
  import { useAxiosGet } from '@/composables/useAxiosGet'
  import { coinsExch } from '@/utils/utils.js'
  import Gw2Card from './Gw2Card.vue'

  const Gw2Store = useGW2Store()
  const demoDataStore = useGw2WalletDemoData()
  const { getApiKey } = storeToRefs(Gw2Store)
  
  const currencies = reactive([])
  const currenciesByOrder = reactive([])
  const gems = reactive([])
  const currencyCount = ref(null)
  const permissionsRestricted = ref(false)
  const endpointUrl = '/v2/account/wallet'
  const qParam = '?access_token='
  let key = ''

  onMounted (async () => {
    let payload = await useAxiosGet('/v2/currencies?ids=all')
    currencies.push(...payload.data)

    currencies[0].coins = {
      copperIcon: 'https://render.guildwars2.com/file/6CF8F96A3299CFC75D5CC90617C3C70331A1EF0E/156902.png',
      silverIcon: 'https://render.guildwars2.com/file/E5A2197D78ECE4AE0349C8B3710D033D22DB0DA6/156907.png',
      goldIcon: 'https://render.guildwars2.com/file/090A980A96D39FD36FBB004903644C6DBEFB1FFB/156904.png',
    }

    currenciesByOrder.push(...sortCurrenciesByOrder())
    if (currenciesByOrder[0].name === 'Gem') {
      gems.push(...currenciesByOrder.splice(0, 1))
    }
  })

  watch(getApiKey, (newApiKey) => newApiKey && getAcctData(newApiKey) || clearAmounts())

  async function getAcctData(key) {
    permissionsRestricted.value = false

    if (key === 'Some User API Key :)') {
      const demoData = JSON.parse(JSON.stringify( demoDataStore.getWalletDemoData ))
      matchAccountValues(demoData)
      return
    } 
    
    const url = `${endpointUrl}${qParam}${key}`
    const payload = await useAxiosGet(url)
    if (payload.connectionSucceeded) matchAccountValues(payload)
    else if (payload.error.code === 403) {
      permissionsRestricted.value = true
      clearAmounts(payload.error.code)
    }
  }

  function matchAccountValues(data) {
    currencyCount.value = (data.data.length - 1) + ' / '

    currencies.forEach(currency => { 
      if (currency.id === data.data[0]?.id) {
        currency.amount = data.data[0].value.toLocaleString()
        data.data.shift()
      }
      else currency.amount = '0'
    })

    currencies[0].coins = coinsExch(currencies[0].amount)
  }

  function clearAmounts(errCode) { 
    currencies.forEach(currancy => currancy.amount = null)
    currencies[0].coins.copperCoins = null
    currencies[0].coins.silverCoins = null
    currencies[0].coins.goldCoins = null
    currencyCount.value = ''
    if (errCode !== 403) permissionsRestricted.value = false
  }

function sortCurrenciesByOrder() {
  return [...currencies].sort((a, b) => a.order - b.order)
}

</script>

<style scoped>
#wallet {
    width: 600px;
    margin: 0 auto;
  }

  #wallet > div {
    margin-bottom: 40px;
  }
  
  .permissionsRestricted {
    color: var(--color-text-primary3)
  }
  .row {
    position: relative;
    display: block;
    margin: 0 0;
    padding: 8px 2px;
    cursor: pointer;
  }

  .row:nth-child(even) {
    background: rgba(255, 255, 255, .08);
  }

  .row:hover .card {
    display: block;
  }

  .row:nth-child(n+55) .card {
    top: auto;
    bottom: 30px;
  }

  .row .name {
    display: inline-block;
    width: 300px;
  }

  .row:hover .name, .row:hover .amount {
    color: var(--color-text-primary3);
    font-weight: bold;
  }

  .row .amount {
    float: right;
    width: 200px;
    text-align: right;
  }

  .row img {
    display: inline-block;
    width: 35px;
    padding-left: 10px;
  }
</style>